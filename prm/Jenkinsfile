pipeline {
    agent any
    environment {
        DOCKER_REPOSITORY_URL = credentials('DOCKER_REPOSITORY_URL')
        AURORA_CLI_CONFIGURATION = credentials('clusters.json')
        INVENTORY = credentials('inventory.yml')
        PRM_SUT = credentials('PRM_SUT')

        PLAYBOOK='/prm/owca/workloads/run_workloads.yaml'
        DEFAULT_INVENTORY='/prm/inventory.yaml'
        LLC_INVENTORY='/prm/demo_scenarios/complex_llc.0/inventory.yaml'
    }
    stages {
        stage("Run flake8 on PRM") {
            steps {
                sh'''
                cd prm
                tox -e flake8
                '''
            }
        }
        stage("Build owca-prm.pex") {
            steps {
                sh'''
                cd prm
                tox -e package
                '''
                stash(name: "owca-prm", includes: "prm/dist/**")
                archiveArtifacts(artifacts: "prm/dist/**")
            }
            post {
                always {
                    sh '''
                    rm -fr prm/dist
                    '''
                }
            }
        }
        stage("Build aurora-cli Docker image") {
            steps {
                sh '''
                cp ${AURORA_CLI_CONFIGURATION} ${WORKSPACE}/prm/clusters.json
                cp ${INVENTORY} ${WORKSPACE}/prm/inventory.yaml
                IMAGE_NAME=${DOCKER_REPOSITORY_URL}/owca/aurora-cli:${GIT_COMMIT}
                docker build -t ${IMAGE_NAME} -f ${WORKSPACE}/prm/build/Dockerfile ${WORKSPACE}/prm
                docker push ${IMAGE_NAME}
                '''
            }
            post {
                always {
                    sh '''
                    rm -fr ${WORKSPACE}/prm/clusters.json ${WORKSPACE}/prm/inventory.yaml
                    '''
                }
            }
        }
        stage("Run LLC experiment") {
            agent {
                docker {
                    image "owca/aurora-cli:debug-2"
                    registryUrl "http://${DOCKER_REPOSITORY_URL}"
                }
            }
            steps {
                sh '''
                ls -la /prm
                ansible-playbook -vvv -l ${PRM_SUT} -i ${LLC_INVENTORY} -i ${DEFAULT_INVENTORY} ${PLAYBOOK} --tags=twemcache_mutilate,redis_rpc_perf,cassandra_stress--cassandra
                '''
            }
            post {
                always {
                    sh '''
                    ansible-playbook -vvv -l ${PRM_SUT} -i ${DEFAULT_INVENTORY} ${PLAYBOOK} --tags=clean_jobs
                    '''
                }
            }
        }
    }
}
